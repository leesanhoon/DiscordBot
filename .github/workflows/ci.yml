name: CI/CD Pipeline

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    build:
        environment: production
        runs-on: ubuntu-latest
        steps:
            # Checkout code v·ªõi full history n·∫øu c·∫ßn
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # L·∫•y full history ƒë·ªÉ t·∫°o version t·ª´ git tag n·∫øu c·∫ßn

            # Cache Docker layers ƒë·ªÉ tƒÉng t·ªëc build
            - name: Cache Docker layers
              uses: actions/cache@v3
              with:
                  path: /tmp/.buildx-cache
                  key: ${{ runner.os }}-buildx-${{ github.sha }}
                  restore-keys: |
                      ${{ runner.os }}-buildx-

            # Thi·∫øt l·∫≠p Buildx ƒë·ªÉ build nhanh h∆°n v√† h·ªó tr·ª£ multi-platform
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            # ƒêƒÉng nh·∫≠p Docker Hub tr∆∞·ªõc ƒë·ªÉ tr√°nh l·ªói auth gi·ªØa ch·ª´ng
            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_HUB_USERNAME }}
                  password: ${{ secrets.DOCKER_HUB_TOKEN }}

            # Thi·∫øt l·∫≠p Node.js v·ªõi cache
            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: "npm"
                  cache-dependency-path: package-lock.json # ƒê·∫£m b·∫£o cache ch√≠nh x√°c

            # C√†i dependencies v·ªõi ki·ªÉm tra l·ªói
            - name: Install dependencies
              run: npm ci --prefer-offline --no-audit
              # --prefer-offline: D√πng cache n·∫øu c√≥
              # --no-audit: B·ªè qua audit ƒë·ªÉ nhanh h∆°n

            # Build v√† push Docker image v·ªõi cache v√† tag versioning
            - name: Build and Push Docker image
              id: docker_build
              run: |
                  # L·∫•y git tag ho·∫∑c commit sha l√†m version
                  VERSION=$(git describe --tags --always --dirty || echo "latest")
                  IMAGE_NAME="${{ secrets.DOCKER_HUB_USERNAME }}/discordbot"
                  docker buildx build \
                    --cache-from type=local,src=/tmp/.buildx-cache \
                    --cache-to type=local,dest=/tmp/.buildx-cache \
                    --tag "${IMAGE_NAME}:${VERSION}" \
                    --tag "${IMAGE_NAME}:latest" \
                    --output type=registry \
                    --push \
                    .
              env:
                  DOCKER_BUILDKIT: 1 # B·∫≠t BuildKit ƒë·ªÉ build nhanh h∆°n

            # Ki·ªÉm tra k·∫øt qu·∫£ build
            - name: Verify build
              run: |
                  echo "Built and pushed image: ${{ secrets.DOCKER_HUB_USERNAME }}/discordbot:${{ steps.docker_build.outputs.version }}"

    deploy:
        needs: build
        runs-on: ubuntu-latest
        environment: production
        steps:
            - name: Deploy to VPS
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USERNAME }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  script: |
                      echo "üîÑ Pulling latest Docker image..."
                      docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/discordbot:latest

                      echo "üõë Stopping old container..."
                      docker stop discordbot || true
                      docker rm discordbot || true

                      echo "üöÄ Running new container..."
                      docker run -d --name discordbot \
                        --env-file /home/root/config/.env \
                        -p 3000:3000 ${{ secrets.DOCKER_HUB_USERNAME }}/discordbot:latest

                      echo "üîç Checking running containers..."
                      docker ps -a

                      echo "üìú Checking Docker logs..."
                      docker logs --tail=50 discordbot || echo "‚ö†Ô∏è No logs found."

                      echo "üõ† Checking container status..."
                      docker inspect discordbot --format '{{.State.Status}}' || echo "‚ö†Ô∏è Container not found."

                      echo "üéØ Deployment completed!"
